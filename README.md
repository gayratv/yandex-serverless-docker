# Как развернуть Serverless Docker Container

Здесь приведены примеры трех bash скриптов, которые Вы должны запустить последовательно. В результате выполенения трех скриптов Вы получите работающий serverless контейнер.

Развертывание будет делаться в ubuntu (wsl для Windows).

### Все команды даются из ubuntu (wsl для windows)

### Подготовка окружения

**Для Windows:**
- [Установите WSL](https://docs.microsoft.com/en-us/windows/wsl/install)
- Запустите Ubuntu Linux


Поставить из wsl **jq** (JSON processor)
[установка](https://stedolan.github.io/jq/download/)
([описание jq](https://stedolan.github.io/jq/))
[doc](https://stedolan.github.io/jq/manual/)


### Cоздайте реестр docker-образов

В сервисе "Container Registry" создайте реестр и занесите его ID в параметр
CONTAINER_REGISTRY
в файле main.env

Реестр проще всего создать через web интерфейс.

Реестр — это хранилище Docker-образов. (Container Registry)

Репозиторий — набор Docker-образов с одинаковым именем (создается при docker push).

В командах YC CLI необходимо использовать имя репозитория без адреса Container Registry:
```yc
yc container image list --repository-name=<ID реестра>/<имя Docker-образа>
```

### Заполните переменные в файле main.env

В файле приведены значения для моего аккаунта. Все приведенные значения не являются секретами и Вы можете их спокойно хранить.

FOLDER_ID - ID каталога в котором Вы будете вести развертывание приложения

CONTAINER_REGISTRY - ID Container Registry (см. предыдущий шаг)

REPOSITORY_NAME - описательное имя для репозитория 

CONTAINER_NAME - описательное имя для контейнера

VERSION - это некий дополнительный тег, который будет применен при сохранении docker образа.

SA_ID - ID сервисного аккаунта который будет сопоставлен с образом контейнера

В дальнейшем Вы сможете использовать привязанный сервисный аккаунт для обращения к сервисам Яндекс (например Yandex Database).

### Сконфигурируйте docker для работы с только что созданным репозиторием с помощью команды:

```bash
yc container registry configure-docker
```

### Соберите docker-образ приложения

(файл конфигурации docker-образа традиционно называется [Dockerfile](Dockerfile)) и загрузите его в созданный на предыдущем шаге репозиторий. 

Для этого выполните команду из корня проекта:

```bash
./deploy/01-docker-build.sh
```

### Создайте serverless-контейнер
выполните команду из корня проекта:

```bash
./deploy/02-sls-create.sh
```

После выполнения этой команды создается "место" для последующего развертывания экземпляра контейнера из образа.

Также формируется файл contid.env в котором содержится ID созданного контейнера. (для последующих комманд)

### Создайте ревизию (экземпляр) контейнера из ранее подготовленного образа.

выполните команду из корня проекта:

```bash
./deploy/03-sls-deploy.sh
```

Обратите внимание что в скрипте задан ряд переменных окружения. Конечно для тестового контейнера они не нужны - но возможно пригодятся Вам в prod.

Так, например, Вы можете через переменные окружения передать секреты в приложение. Правда стоить помнить, что они будут видны тем, кто сломает Ваш аккаунт на Яндекс.

Более безопасный способ - это хранить секреты в Lockbox.
Вот статья [Николая Матросова](https://nikolaymatrosov.medium.com/%D0%BA%D0%B0%D0%BA-%D0%B4%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%B8%D1%82%D1%8C-%D1%81%D0%B5%D0%BA%D1%80%D0%B5%D1%82%D1%8B-%D0%B2-coi-%D0%BF%D1%80%D0%B8-%D1%80%D0%B0%D0%B7%D0%B2%D0%B5%D1%80%D1%82%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D0%B8-docker-compose-e3d69a518034)

### Проверка

Зайдите в web консоль, перейдите в  "Serverless Containers" и нажмите на ссылку только что развернутого контейнера.